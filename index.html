<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Custom Slot Machine</title>
  <style>
       body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #f0f0f0;
    }

    /* Toolbar */
    #toolbar {
      display: flex;
      justify-content: center;
      padding: 12px;
      background: rgba(0,0,0,0.5);
      border-bottom: 2px solid #444;
      flex-shrink: 0;
      backdrop-filter: blur(6px);
    }

    button {
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      color: white;
      border: none;
      padding: 12px 22px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: transform 0.2s ease, background 0.3s ease;
    }
    button:hover {
      background: linear-gradient(135deg, #43e97b, #38f9d7);
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(1px);
    }

    /* Canvas area */
    #canvas {
      flex: 1;
      width: 100%;
      max-width: 1024px;
      aspect-ratio: 1/1;
      background: linear-gradient(145deg, #1c1c1c, #292929);
      border-radius: 16px;
      border: 2px solid #444;
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
      position: relative;
      overflow: hidden;
      margin: 16px auto;
    }

    
    .reel {
      position: absolute;
      background: linear-gradient(135deg, rgba(0,180,255,0.9), rgba(0,120,255,0.7));
      border: 2px solid #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      cursor: pointer;
      transition: box-shadow 0.2s ease;
    }
    .reel:hover {
      box-shadow: 0 6px 16px rgba(0,0,0,0.6);
    }

    .handle {
      width: 14px;
      height: 14px;
      background: #ffcc00;
      border: 2px solid #fff;
      border-radius: 50%;
      position: absolute;
      bottom: -8px;
      right: -8px;
      cursor: se-resize;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

  
    #messageArea {
      display: flex;
      flex-direction: column;
      padding: 12px;
      background: rgba(0,0,0,0.7);
      border-top: 2px solid #444;
      flex-shrink: 0;
      width: 100%;
      max-width: 1024px;
      margin: 0 auto;
      border-radius: 0 0 16px 16px;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.5);
    }

    #msgInput {
      width: 100%;
      height: 60px;
      padding: 8px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      margin-bottom: 8px;
      background: #1e1e1e;
      color: #fff;
    }
    #msgInput:focus {
      outline: 2px solid #4facfe;
    }

    #messages {
      width: 100%;
      max-height: 150px;
      overflow-y: auto;
      padding: 6px;
      margin-bottom: 8px;
      background: #111;
      border-radius: 8px;
      box-shadow: inset 0 2px 6px rgba(0,0,0,0.6);
      font-size: 14px;
    }
    .message.user { color: #4facfe; margin-bottom: 4px; }
    .message.bot { color: #43e97b; margin-bottom: 4px; }

    #waitMessage { display: none; color: #ff8080; margin-bottom: 6px; font-weight: bold; }

    #progressContainer {
      width: 100%;
      height: 10px;
      background: #333;
      margin-bottom: 6px;
      border-radius: 6px;
      overflow: hidden;
      display: none;
    }
    #progressFill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #4facfe, #00f2fe);
      transition: width 0.3s ease;
    }

    #links { display: none; margin-bottom: 6px; }
    #links a {
      color: #00f2fe;
      text-decoration: none;
      margin: 0 6px;
      font-weight: bold;
    }
    #links a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div id="toolbar">
    <button id="addReel">Insert reel</button>
  </div>
  <div id="canvas"></div>
  <div id="messageArea">
    <div id="messages"></div>
    <textarea id="msgInput" placeholder="Type prompt..."></textarea>
    <div id="waitMessage">Waiting for reply...</div>
    <div id="progressContainer"><div id="progressFill"></div></div>
    <div id="links">
      <a id="playLink" href="#" target="_blank">Play Game</a> |
      <a id="downloadLink" href="#" target="_blank">Download Game</a>
    </div>
    <button id="send">Send</button>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const sendButton = document.getElementById("send");
    const url = "https://5ec71ab73fd0.ngrok-free.app";
    const session_id = "user_" + Math.floor(Math.random() * 1000000);

    document.getElementById('addReel').onclick = () => { addReel() };

    function addReel() {
      const reel = document.createElement('div');
      reel.classList.add('reel');
      reel.style.width = '100px';
      reel.style.height = '100px';
      reel.style.left = '50%';
      reel.style.top = '50%';
      reel.dataset.angle = 0;

      const handle = document.createElement('div');
      handle.classList.add('handle');
      reel.appendChild(handle);

      canvas.appendChild(reel);
      makeDraggable(reel);
      makeResizable(reel, handle);

      reel.oncontextmenu = e => { e.preventDefault(); reel.remove() };
    }

    function makeDraggable(el) {
      let startX, startY, origX, origY;
      el.addEventListener('mousedown', e => {
        if (e.target.classList.contains('handle')) return;
        startX = e.clientX; startY = e.clientY;
        const rect = el.getBoundingClientRect();
        const parent = canvas.getBoundingClientRect();
        origX = rect.left - parent.left;
        origY = rect.top - parent.top;

        function moveHandler(ev) {
          let newX = origX + (ev.clientX - startX);
          let newY = origY + (ev.clientY - startY);


          newX = Math.max(0, Math.min(newX, canvas.clientWidth - el.offsetWidth));
          newY = Math.max(0, Math.min(newY, canvas.clientHeight - el.offsetHeight));

          el.style.left = newX + 'px';
          el.style.top = newY + 'px';
        }
        function upHandler() {
          document.removeEventListener('mousemove', moveHandler);
          document.removeEventListener('mouseup', upHandler);
        }
        document.addEventListener('mousemove', moveHandler);
        document.addEventListener('mouseup', upHandler);
      });
    }

    function makeResizable(el, handle) {
      let startX, startY, startW, startH;
      handle.addEventListener('mousedown', e => {
        e.stopPropagation();
        startX = e.clientX; startY = e.clientY;
        startW = el.offsetWidth; startH = el.offsetHeight;

        function moveHandler(ev) {
          let newW = Math.max(20, startW + (ev.clientX - startX));
          let newH = Math.max(20, startH + (ev.clientY - startY));

         
          newW = Math.min(newW, canvas.clientWidth - el.offsetLeft);
          newH = Math.min(newH, canvas.clientHeight - el.offsetTop);

          el.style.width = newW + 'px';
          el.style.height = newH + 'px';
        }
        function upHandler() {
          document.removeEventListener('mousemove', moveHandler);
          document.removeEventListener('mouseup', upHandler);
        }
        document.addEventListener('mousemove', moveHandler);
        document.addEventListener('mouseup', upHandler);
      });
    }

   
    document.removeEventListener('wheel', () => {});

    function addMessage(text, sender) {
      const msgDiv = document.createElement("div");
      msgDiv.className = "message " + sender;
      msgDiv.textContent = (sender === "user" ? "You: " : "Bot: ") + text;
      document.getElementById("messages").appendChild(msgDiv);
      document.getElementById("messages").scrollTop =
        document.getElementById("messages").scrollHeight;
    }

    function sendMessage() {
      const input = document.getElementById("msgInput");
      const message = input.value.trim();
      if (!message || sendButton.disabled) return;

      const reels = document.querySelectorAll('.reel');
      const parent = canvas.getBoundingClientRect();

      const rects = Array.from(reels).map(r => {
        const rect = r.getBoundingClientRect();
        return {
          x: (rect.left - parent.left + rect.width / 2) / canvas.clientWidth * 1024,
          y: (rect.top - parent.top + rect.height / 2) / canvas.clientHeight * 1024,
          width: rect.width / canvas.clientWidth * 1024,
          height: rect.height / canvas.clientHeight * 1024,
          rotation: 0   // always force 0
        };
      });

      addMessage(message, "user");
      input.value = "";
      document.getElementById("waitMessage").style.display = "block";

      fetch(`${url}/receive_message`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: message,
          session_id: session_id,
          rects: rects
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "True") {
          addMessage(data.reply, "bot");
        } else {
          addMessage("Error: " + data.reply, "bot");
        }
        document.getElementById("waitMessage").style.display = "none";
      })
      .catch(err => {
        addMessage("Connection error. Please try again later.", "bot");
        document.getElementById("waitMessage").style.display = "none";
      });
    }

    function checkStatus() {
      fetch(`${url}/get_status`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session_id: session_id })
      })
      .then(res => res.json())
      .then(data => {
        const percent = data.process_percent;
        const progressContainer = document.getElementById("progressContainer");
        const progressFill = document.getElementById("progressFill");
        const links = document.getElementById("links");

        if (percent > 0 && percent < 100) {
          progressContainer.style.display = "block";
          links.style.display = "none";
          progressFill.style.width = percent + "%";
          sendButton.disabled = true;
        } else if (percent === 100) {
          progressFill.style.width = "100%";
          progressContainer.style.display = "block";
          links.style.display = "block";
          const baseUrl = url;
          document.getElementById("playLink").href = baseUrl + data.game_link;
          document.getElementById("downloadLink").href = baseUrl + data.download_link;
          const iframe = document.getElementById("gamePreview");
          if (iframe) iframe.src = baseUrl + data.game_link;
        } else {
          progressContainer.style.display = "none";
          links.style.display = "none";
          progressFill.style.width = "0%";
        }
      })
      .catch(err => console.error("Error checking status:", err));
    }

    setInterval(checkStatus, 1000);
    sendButton.onclick = sendMessage;
  </script>
</body>
</html>
