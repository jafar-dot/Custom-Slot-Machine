<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Slot Custom Shape</title>
<style>
body { margin:0; padding:0; display:flex; flex-direction:column; height:100vh; font-family:Arial,sans-serif; }
#home { display:flex; justify-content:center; align-items:center; flex:1; }
#canvasPage { display:none; flex-direction:column; align-items:center; flex:1; }
#buttons { display:flex; justify-content:center; margin:10px 0; flex-shrink:0; }
#canvas { flex:1; width:90%; max-width:1024px; aspect-ratio:1/1; background:#fff; border:1px solid #ccc; position:relative; overflow:hidden; }
.reel { position:absolute; background:rgba(0,150,255,0.5); cursor:move; transform-origin:0 0; }
.handle { width:12px; height:12px; background:#000; position:absolute; bottom:-6px; right:-6px; cursor:se-resize; }
</style>
</head>
<body>
<div id="home">
  <button id="goCustom">Go to Custom Shape</button>
</div>
<div id="canvasPage">
  <div id="buttons">
    <button id="addReel">Add Reel</button>
    <button id="back">Back</button>
  </div>
  <div id="canvas"></div>
  <div id="messageArea" style="width:90%; max-width:1024px; margin:10px 0; display:flex; flex-direction:column;">
    <textarea id="msgInput" style="width:100%; height:60px; padding:5px;" placeholder="Type message..."></textarea>
    <button id="send" style="margin-top:5px;">Send Data</button>
  </div>
</div>
<script>
const home=document.getElementById('home')
const canvasPage=document.getElementById('canvasPage')
const canvas=document.getElementById('canvas')
document.getElementById('goCustom').onclick=()=>{home.style.display='none'; canvasPage.style.display='flex'}
document.getElementById('back').onclick=()=>{canvasPage.style.display='none'; home.style.display='flex'}

document.getElementById('addReel').onclick=()=>{addReel()}
function addReel(){
  const reel=document.createElement('div')
  reel.classList.add('reel')
  reel.style.width='100px'
  reel.style.height='200px'
  reel.style.left='50%'
  reel.style.top='50%'
  reel.style.transform='translate(-50%,-50%) rotate(0deg)'
  reel.dataset.angle=0
  const handle=document.createElement('div')
  handle.classList.add('handle')
  reel.appendChild(handle)
  canvas.appendChild(reel)
  makeDraggable(reel)
  makeRotatable(reel)
  makeResizable(reel,handle)
  reel.oncontextmenu=e=>{e.preventDefault(); reel.remove()}
}

function makeDraggable(el){
  let startX,startY,origX,origY
  el.addEventListener('mousedown',e=>{
    if(e.target.classList.contains('handle'))return
    startX=e.clientX; startY=e.clientY
    const rect=el.getBoundingClientRect()
    const parent=canvas.getBoundingClientRect()
    origX=rect.left-parent.left; origY=rect.top-parent.top
    function moveHandler(ev){
      let newX=origX+(ev.clientX-startX)
      let newY=origY+(ev.clientY-startY)
      newX=Math.max(0,Math.min(newX,canvas.clientWidth-el.offsetWidth))
      newY=Math.max(0,Math.min(newY,canvas.clientHeight-el.offsetHeight))
      el.style.left=newX+'px'
      el.style.top=newY+'px'
      el.style.transform=`rotate(${el.dataset.angle}deg)`
    }
    function upHandler(){document.removeEventListener('mousemove',moveHandler); document.removeEventListener('mouseup',upHandler)}
    document.addEventListener('mousemove',moveHandler)
    document.addEventListener('mouseup',upHandler)
  })
}

function makeRotatable(el){
  el.addEventListener('wheel',e=>{
    e.preventDefault()
    let angle=parseFloat(el.dataset.angle)||0
    angle+=e.deltaY>0?5:-5
    el.dataset.angle=angle
    el.style.transform=`rotate(${angle}deg)`
    const handle=el.querySelector('.handle')
    handle.style.transform=`rotate(${-angle}deg)`
    constrainRotation(el)
  })
}

function makeResizable(el,handle){
  let startX,startY,startW,startH
  handle.addEventListener('mousedown',e=>{
    e.stopPropagation()
    startX=e.clientX; startY=e.clientY
    startW=el.offsetWidth; startH=el.offsetHeight
    function moveHandler(ev){
      let newW=Math.max(20,startW+(ev.clientX-startX))
      let newH=Math.max(20,startH+(ev.clientY-startY))
      el.style.width=newW+'px'
      el.style.height=newH+'px'
      constrainRotation(el)
    }
    function upHandler(){document.removeEventListener('mousemove',moveHandler); document.removeEventListener('mouseup',upHandler)}
    document.addEventListener('mousemove',moveHandler)
    document.addEventListener('mouseup',upHandler)
  })
}

function constrainRotation(el){
  const rect=el.getBoundingClientRect()
  const parent=canvas.getBoundingClientRect()
  let offsetX=rect.left-parent.left, offsetY=rect.top-parent.top
  let w=rect.width, h=rect.height
  if(offsetX<0) el.style.left='0px'
  if(offsetY<0) el.style.top='0px'
  if(offsetX+w>canvas.clientWidth) el.style.left=(canvas.clientWidth-w)+'px'
  if(offsetY+h>canvas.clientHeight) el.style.top=(canvas.clientHeight-h)+'px'
}

document.getElementById('send').onclick=()=>{
  const reels=document.querySelectorAll('.reel')
  const data=Array.from(reels).map(r=>{
    const rect=r.getBoundingClientRect()
    const parent=canvas.getBoundingClientRect()
    const angle=parseFloat(r.dataset.angle)||0
    const x=(rect.left-parent.left+rect.width/2)/canvas.clientWidth*1024
    const y=(rect.top-parent.top+rect.height/2)/canvas.clientHeight*1024
    const w=rect.width/canvas.clientWidth*1024
    const h=rect.height/canvas.clientHeight*1024
    return {x,y,width:w,height:h,rotation:angle}
  })
  console.log("Message:", document.getElementById('msgInput').value)
  console.log("Rects:", JSON.stringify(data))
}
</script>
</body>
</html>
